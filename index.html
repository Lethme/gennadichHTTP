<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

    <!-- Materialize CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

    <!-- CSS -->
    <link rel="stylesheet" href="./assets/css/style.css">

    <title>HTTP</title>

    <style>
        .page_code {
            width: 100%;
            max-width: 1300px;
            height: 100%;
            max-height: 900px;
            overflow: auto;
            margin: 15px;
            padding: 10px;
            border: 2px solid black;
            text-align: left;
        }
    </style>
</head>

<body>
    <div id="page">
        <h1>Test Page</h1>
        <h4 class='item'>Here should be your text</h4>
    </div>

    <div class="page_code"></div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

    <script>
        window.$ = window.jQuery = require('jquery');
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- <script src="./render.js"></script> -->

    <script>
        const electron = require('electron');
        const {
            ipcRenderer
        } = electron;

        ipcRenderer.on('item:test', (e, item) => {
            $('.item').html(item);
            getPageCode(item);
        });

        ipcRenderer.on('http:body', (e, body, links, link_tags) => {
            $('.page_code').empty().append('<p>' + body + '</p><br>');

            link_tags.forEach(link_tag => {
                $('.page_code').append('<p>"' + link_tag.replace(/</gm, '&lt;').replace(/>/gm, '&gt;') + '"</p>');
            });

            $('.page_code').append('<br>');

            links.forEach(link => {
                $('.page_code').append('<p>"' + link + '"</p>');
            });
        });

        function getPageCode(host) {
            const request = require('request');
            request(host, (error, response, body) => {
                console.error('error:', error);
                console.log('statusCode:', response && response.statusCode);
                console.log(body);

                //saveFile('testpage', body);

                let links = [];
                let link_tags = body.match(/<link[\s]+([^>]+)>/gm);

                if (link_tags !== null) {
                    link_tags.forEach(link => {
                        let temp_array = (new RegExp(/href=(["'])(.*?)\1/g)).exec(link);
                        if (temp_array[2].includes('.css') && temp_array.input.includes('stylesheet')) {
                            const isUrlAbsolute = (url) => (url.indexOf('://') > 0 || url.indexOf('//') === 0)
                            if (isUrlAbsolute(temp_array[2])) {
                                links.push(temp_array[2]);
                            } else {
                                const url = require('url');
                                links.push(url.resolve(host, temp_array[2]));
                                //links.push(new URL(temp_array[2], 'http://lab.volpi.ru/examples/').href);
                            }
                        }
                    });
                }

                let temp_body = body.replace(/</gm, '&lt;').replace(/>/gm, '&gt;');

                $('.page_code').empty().append('<p>' + temp_body + '</p><br>');

                link_tags.forEach(link_tag => {
                    $('.page_code').append('<p>"' + link_tag.replace(/</gm, '&lt;').replace(/>/gm, '&gt;') + '"</p>');
                });

                $('.page_code').append('<br>');

                links.forEach(link => {
                    $('.page_code').append('<p>"' + link + '"</p>');
                });

                // /<[^>]+href\s*=\s*['"]([^'"]+)['"][^>]*>/gm
                console.log(link_tags);
                console.log(links);
            });
        }
    </script>
</body>

</html>